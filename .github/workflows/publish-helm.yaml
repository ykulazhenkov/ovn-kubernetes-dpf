name: Publish Helm Chart

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  publish-helm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Determine tag
        id: tag
        run: |
          # Convert repository owner to lowercase to handle uppercase characters
          REPOSITORY=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "REGISTRY=ghcr.io/${REPOSITORY}" >> $GITHUB_ENV

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            TAG=v25.7.1-${GITHUB_SHA::7}
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
      
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin
      
      - name: Build Helm chart
        if: github.event_name == 'pull_request'
        run: |
          make helm-build TAG=${{ steps.tag.outputs.tag }} REGISTRY=${{ env.REGISTRY }}
      
      - name: Build and publish Helm chart
        if: github.event_name != 'pull_request'
        run: |
          make helm-publish TAG=${{ steps.tag.outputs.tag }} REGISTRY=${{ env.REGISTRY }}
